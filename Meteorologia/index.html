<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SMADSOT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Original libraries -->
    <script src="./lib/jquery.min.js"></script>
    <script src="./lib/chart.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="./bootstrap/bootstrap.min.js"></script>
    <script src="./bootstrap/dropdowns/dropdowns-enhancement.js"></script>
    <script src="./bootstrap/datepicker/bootstrap-datepicker.js"></script>
    <script src="./bootstrap/dialog/bootstrap-dialog.js"></script>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="./bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="./bootstrap/dropdowns/dropdowns-enhancement.css" />
    <link rel="stylesheet" href="./bootstrap/datepicker/bootstrap-datepicker.css" />
    <link rel="stylesheet" href="./bootstrap/dialog/bootstrap-dialog.css" />

    <link rel="stylesheet" href="./css/estilos.css" />

    <script src="./lib/dom-to-image.js"></script>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&amp;display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-brand-color: #5a1b30;
            --secondary-brand-color: #c19862;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --text-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #ddd;
            --sidebar-width: 80px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            background-color: var(--light-gray);
        }

        /* Hide landing page when map is active */
        body.map-active #banner,
        body.map-active #botones1 {
            display: none;
        }

        body.map-active {
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        body.map-active #app {
            display: flex !important;
            flex-grow: 1;
            overflow: hidden;
            height: 100%;
        }

        /* Map-specific styles */
        #main-content { 
            flex-grow: 1; 
            position: relative;
            display: none;
            width: calc(100% - var(--sidebar-width));
        }

        body.map-active #main-content {
            display: block;
        }

        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
            height: 100%;
        }
        
        #map-watermark {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            height: 40px;
            opacity: 0.8;
            pointer-events: none;
        }
        
        /* Enhanced Map Controls - Fixed positioning to avoid navbar overlap */
        .map-controls {
            position: absolute;
            top: 180px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background-color: white;
            color: var(--primary-brand-color);
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .control-btn:hover { 
            background-color: var(--primary-brand-color); 
            color: white; 
            transform: scale(1.1); 
        }

        /* Back button styles */
        .back-btn {
            width: 60px;
            height: 60px;
            border: 2px solid var(--primary-brand-color);
            background: var(--primary-brand-color);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-decoration: none;
            margin: 5px 0;
        }

        .back-btn:hover {
            background: white;
            color: var(--primary-brand-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 27, 48, 0.3);
        }

        .weather-controls {
            position: absolute;
            top: 180px;
            right: 0;
            width: 380px;
            height: calc(100% - 340px);
            background: white;
            border-radius: 8px;
            box-shadow: -5px 0 25px var(--shadow-color);
            z-index: 1002;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .weather-controls.is-open { transform: translateX(0); }
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 10px 20px;
            border-bottom: 2px solid var(--secondary-brand-color);
        }
        .controls-header h3 { color: var(--primary-brand-color); font-size: 1.2rem; margin: 0; }
        .controls-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; flex-grow: 1; }
        .close-btn { background: none; border: none; font-size: 2rem; color: var(--dark-gray); cursor: pointer; line-height: 1; padding: 0 5px; transition: color 0.3s ease; }
        .close-btn:hover { color: var(--primary-brand-color); }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 500; font-size: 14px; }
        .control-group select, .control-group input { width: 100%; padding: 10px; border: 2px solid var(--medium-gray); border-radius: 8px; font-size: 14px; font-family: 'Poppins', sans-serif; transition: all 0.3s ease; }
        .control-group select:focus, .control-group input:focus { outline: none; border-color: var(--secondary-brand-color); }
        .layer-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .layer-btn { padding: 12px 5px; border: 2px solid var(--medium-gray); background: white; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 12px; font-weight: 500; color: #666; }
        .layer-btn:hover { border-color: var(--secondary-brand-color); color: var(--secondary-brand-color); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(193, 152, 98, 0.2); }
        .layer-btn.active { background: linear-gradient(135deg, var(--primary-brand-color), var(--secondary-brand-color)); color: white; border-color: transparent; }
        .layer-btn i { display: block; font-size: 24px; margin-bottom: 5px; }
        .animation-controls { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; }
        .play-btn { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-brand-color), var(--secondary-brand-color)); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(90, 27, 48, 0.3); flex-shrink: 0; font-size: 20px; }
        .play-btn:hover { transform: scale(1.1); box-shadow: 0 8px 20px rgba(90, 27, 48, 0.4); }
        .speed-slider { flex: 1; }
        .speed-slider input[type="range"] { width: 100%; }

        /* Control footer buttons */
        .controls-footer {
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .footer-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--primary-brand-color);
            background: white;
            color: var(--primary-brand-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .footer-btn:hover {
            background: var(--primary-brand-color);
            color: white;
        }

        /* Enhanced Gradient Scale */
        .legend { 
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 5px 20px var(--shadow-color); 
            z-index: 1000; 
            width: 250px;
            cursor: pointer;
            user-select: none;
        }
        .legend-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text-color); text-align: center; }
        .legend-gradient { 
            width: 100%; 
            height: 20px; 
            border-radius: 5px; 
            position: relative;
            cursor: pointer;
        }
        .legend-labels { display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; color: var(--dark-gray); }
        .legend-labels span { flex: 1; text-align: center; }
        .legend-labels span:first-child { text-align: left; }
        .legend-labels span:last-child { text-align: right; }

        /* Filter indicator */
        .filter-indicator {
            position: absolute;
            top: -5px;
            left: 0;
            height: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 3px;
            pointer-events: none;
            display: none;
        }

        /* On-Map Data Panels */
        .data-panel { 
            position: absolute; 
            bottom: 20px; 
            left: calc(var(--sidebar-width) + 20px);
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border-radius: 15px; 
            padding: 15px; 
            box-shadow: 0 10px 30px var(--shadow-color); 
            width: 300px; 
            z-index: 1000; 
        }
        .data-panel h4 { margin-bottom: 10px; color: var(--primary-brand-color); }
        .data-value { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .data-value:last-child { border-bottom: none; }
        .data-label { color: var(--dark-gray); }
        .data-number { font-weight: 600; color: var(--text-color); }

        /* Side menu when map is active */
        .side-menu {
            width: var(--sidebar-width);
            background-color: #fff;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border-right: 1px solid var(--border-color);
            z-index: 1010;
            flex-shrink: 0;
            height: 100%;
        }

        /* Menu button styles */
        .menu-btn {
            width: 60px;
            height: 60px;
            border: 2px solid var(--medium-gray);
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--dark-gray);
            text-decoration: none;
            margin: 5px 0;
        }

        .menu-btn:hover {
            color: var(--primary-brand-color);
            border-color: var(--secondary-brand-color);
            background: var(--secondary-brand-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(193, 152, 98, 0.2);
        }

        .menu-btn.active {
            background: linear-gradient(135deg, var(--primary-brand-color), var(--secondary-brand-color));
            color: white;
            border-color: transparent;
        }

        .menu-label {
            display: none;
        }

        /* Municipality Data Modal */
        .municipality-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        /* --- And replace it with this --- */
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%; /* Add this for flexibility */
            max-width: 900px; /* Increase this value */
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary-brand-color);
        }

        .modal-title {
            color: var(--primary-brand-color);
            font-size: 1.4rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--dark-gray);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--primary-brand-color);
        }

        .pollutant-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .pollutant-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            background: var(--light-gray);
        }

        .pollutant-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .pollutant-info {
            flex: 1;
        }

        .pollutant-name {
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }

        .pollutant-value {
            font-weight: 600;
            color: var(--text-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .download-btn {
            position: absolute;
            top: -5px;
            right: 0;
            padding: 8px 15px;
            background: var(--secondary-brand-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: var(--primary-brand-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
            }
            
            body.map-active #app {
                display: flex !important;
                flex-grow: 1;
                overflow: hidden;
                margin-top: 80px;
                height: calc(100vh - 80px);
            }
            
            body.map-active .side-menu { 
                flex-direction: row; 
                width: 100%; 
                height: auto;
                justify-content: space-around; 
                border-right: none; 
                border-bottom: 1px solid var(--border-color); 
                padding: 10px 5px; 
                gap: 5px; 
            }
            
            #main-content {
                width: 100%;
                height: calc(100% - 80px);
            }
            
            .menu-btn { 
                width: auto; 
                flex: 1; 
                margin: 0 2px; 
                height: 50px;
                font-size: 20px;
            }
            
            .weather-controls {
                position: absolute;
                top: 20px;
                right: 0px;
                width: calc(100% - 40px);
                max-width: 380px;
                height: calc(100% - 40px);
                background: white;
                box-shadow: -5px 0 25px var(--shadow-color);
                z-index: 1002;
                display: flex;
                flex-direction: column;
                transform: translateX(100%);
                transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }
            
            .map-controls {
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 1001;
            }
            
            .data-panel { 
                left: 20px;
                width: calc(100% - 40px);
                max-width: 300px;
            }
            
            #map-watermark { 
                display: none; 
            }

            .modal-content {
                margin: 10px;
                max-width: calc(100% - 20px);
                width: calc(100% - 20px);
                max-height: calc(100% - 20px);
                padding: 20px;
            }

            .pollutant-summary {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .chart-container {
                height: 250px;
                padding: 10px;
            }

            .modal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .download-btn {
                align-self: flex-end;
                margin-top: 10px;
            }
        }
    </style>
  </head>
  <body>
    <!-- Original Navbar -->
    <nav class="navbar">
      <div class="navbar-container">
        <a class="navbar-logo">
          <img src="./images/header/SMADSOTlogo.jpg" alt="Logos" class="navbar-icon" />
        </a>

        <div class="hamburger-menu" onclick="toggleMenu()">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>

        <ul class="nav-links" id="nav-links">
          <li><a onclick="location.reload()">Inicio</a></li>
          <li><a href="https://smadsot.puebla.gob.mx/quienes-somos-1">Quienes Somos</a></li>
          <li><a href="https://smadsot.puebla.gob.mx/avisos-de-privacidad">Avisos de Privacidad</a></li>
          <li><a href="https://ventanilladigital.puebla.gob.mx/">Trámites</a></li>
          <li><a href="http://transparencia.puebla.gob.mx/">Transparencia</a></li>
          <li><a href="https://smadsot.puebla.gob.mx/verificacion">Verificación</a></li>
          <li class="mobile-only"><a href="#" id="btn_atmos_mobile">Atmósfera</a></li>
          <li class="mobile-only"><a href="#" id="btn_aire_mobile">Calidad del aire</a></li>
          <li class="mobile-only"><a href="#" id="btn_hist_mobile">Historial</a></li>
          <li class="social-icons">
            <a href="https://twitter.com/AmbienteGobPue" target="_blank">
              <img src="./images/twitter.svg" alt="Twitter" />
            </a>
          </li>
          <li class="social-icons">
            <a href="https://www.facebook.com/Medio-Ambiente-Desarrollo-Sustentable-y-Ordenamiento-Territorial-110848296920026/" target="_blank">
              <img src="./images/facebook.svg" alt="Facebook" />
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Original Landing Page -->
    <section class="banner" id="banner">
      <div class="banner-content">
        <h1 class="banner-title">
          Pronóstico meteorológico y de calidad del aire para el Estado de Puebla
        </h1>
        <p class="banner-subtitle">
          En esta página encontrarás datos sobre la calidad del aire y el pronóstico del clima obtenidos a través del modelo WRF.
        </p>
      </div>
    </section>

    <!-- Original Cards -->
    <div class="row" style="margin: 50px" id="botones1">
      <div class="col-12 col-md-6 mb-4" id="meteo">
        <div class="card">
          <a href="#" class="card-link" onclick="activateMap('meteorologia'); return false;">
            <div class="card-img" style="background-image: url('./images/Tarjetas/tarjeta-calidad-aire.avif');">
              <div class="card-text">
                <h3>Meteorología</h3>
              </div>
            </div>
          </a>
        </div>
      </div>

      <div class="col-12 col-md-6 mb-4" id="cali">
        <div class="card">
          <a href="#" class="card-link" onclick="activateMap('calidad'); return false;">
            <div class="card-img" style="background-image: url('./images/Tarjetas/tarjeta-calidad-aire.avif');">
              <div class="card-text">
                <h3>Calidad del aire</h3>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- Map and Controls Section -->
    <div id="app" style="display: none;">
      <!-- Fixed Sidebar -->
      <div id="side-menu" class="side-menu">
        <button class="back-btn" id="btn_back" title="Volver al inicio">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
        <button class="menu-btn" id="btn_atmos" title="Atmósfera">
          <i class="fa-solid fa-temperature-half"></i> <span class="menu-label">Meteorología</span>
        </button>
        <button class="menu-btn" id="btn_aire" title="Calidad del aire">
          <i class="fa-solid fa-smog"></i> <span class="menu-label">Calidad del aire</span>
        </button>
        <button class="menu-btn" id="btn_hist" title="Historial">
          <i class="fa-solid fa-chart-line"></i> <span class="menu-label">Historial</span>
        </button>
      </div>

      <!-- Enhanced Map Implementation -->
      <div id="main-content">
        <div id="map"></div>
        <img id="map-watermark" src="https://smadsot.puebla.gob.mx/images/headers/2022/logo-puebla-contigo-blanco-2022.png" alt="Puebla Gobierno" />
        
        <!-- Enhanced Map Controls -->
        <div class="map-controls">
          <button class="control-btn" id="toggle-controls-btn" title="Control de Capas">
            <i class="fa-solid fa-layer-group"></i>
          </button>
          <button class="control-btn" id="zoom-in-btn" title="Acercar">
            <i class="fa-solid fa-plus"></i>
          </button>
          <button class="control-btn" id="zoom-out-btn" title="Alejar">
            <i class="fa-solid fa-minus"></i>
          </button>
          <button class="control-btn" id="reset-north-btn" title="Orientar al Norte">
            <i class="fa-solid fa-compass"></i>
          </button>
          <button class="control-btn" id="reset-position-btn" title="Posición Inicial">
            <i class="fa-solid fa-house"></i>
          </button>
        </div>

        <div class="weather-controls" id="weather-controls">
          <div class="controls-header">
            <h3>Control de Capas</h3>
            <button class="close-btn" id="close-controls-btn" title="Cerrar panel">&times;</button>
          </div>
          <div class="controls-body">
            <div class="control-group">
              <label for="select_run">Fecha del Pronóstico</label>
              <select id="select_run">
                <option value="2025-08-20">20 Agosto 2025</option>
                <option value="2025-08-21">21 Agosto 2025</option>
                <option value="2025-08-22" selected>22 Agosto 2025</option>
              </select>
            </div>
            <div class="control-group">
              <label for="selectHora">Pronósticos a (horas)</label>
              <select id="selectHora">
                <option value="12">12 horas</option>
                <option value="24" selected>24 horas</option>
                <option value="48">48 horas</option>
                <option value="72">72 horas</option>
              </select>
            </div>
            <div class="control-group">
              <label for="select_dat">Parámetro</label>
              <select id="select_dat">
                <option value="meteorologia">Meteorología</option>
                <option value="calidad">Calidad del aire</option>
              </select>
            </div>
            <div class="control-group">
              <label for="select_var">Sub-parámetro</label>
              <select id="select_var">
                <option value="temperature">Temperatura</option>
                <option value="humidity">Humedad</option>
                <option value="precipitation">Precipitación</option>
                <option value="wind">Viento</option>
              </select>
            </div>
            <div class="layer-buttons">
              <button class="layer-btn" data-layer="temperature"><i class="fa-solid fa-temperature-half"></i> Temperatura</button>
              <button class="layer-btn" data-layer="humidity"><i class="fa-solid fa-droplet"></i> Humedad</button>
              <button class="layer-btn" data-layer="precipitation"><i class="fa-solid fa-cloud-showers-heavy"></i> Precipitación</button>
              <button class="layer-btn" data-layer="wind"><i class="fa-solid fa-wind"></i> Viento</button>
              <button class="layer-btn" data-layer="pressure"><i class="fa-solid fa-gauge-high"></i> Presión</button>
              <button class="layer-btn" data-layer="radiation"><i class="fa-solid fa-sun"></i> Radiación</button>
              <button class="layer-btn" data-layer="co"><i class="fa-solid fa-smog"></i> CO</button>
              <button class="layer-btn" data-layer="no2"><i class="fa-solid fa-smog"></i> NO₂</button>
              <button class="layer-btn" data-layer="o3"><i class="fa-solid fa-smog"></i> O₃</button>
              <button class="layer-btn" data-layer="pm25"><i class="fa-solid fa-smog"></i> PM2.5</button>
            </div>
            <div class="animation-controls">
              <button class="play-btn" id="playBtn"><i class="fa-solid fa-play" id="playIcon"></i></button>
              <div class="speed-slider">
                <label for="speedSlider" style="font-size: 12px; color: #666;">Velocidad</label>
                <input type="range" min="100" max="2000" value="1000" id="speedSlider">
              </div>
            </div>
            <div class="controls-footer">
              <button class="footer-btn" id="btn_glosario">
                <i class="fa-solid fa-book"></i> Glosario
              </button>
              <button class="footer-btn" id="btn_datos">
                <i class="fa-solid fa-download"></i> Datos
              </button>
              <button class="footer-btn" id="btn_recarga">
                <i class="fa-solid fa-reload"></i> Recargar
              </button>
            </div>
          </div>
        </div>
        
        <div class="data-panel" id="dataPanel">
          <h4>Datos Actuales (Punto Central)</h4>
          <div class="data-value"><span class="data-label">Temperatura</span><span class="data-number" id="tempValue">--°C</span></div>
          <div class="data-value"><span class="data-label">Humedad</span><span class="data-number" id="humidityValue">--%</span></div>
          <div class="data-value"><span class="data-label">Viento</span><span class="data-number" id="windValue">-- km/h</span></div>
          <div class="data-value"><span class="data-label">Presión</span><span class="data-number" id="pressureValue">-- hPa</span></div>
        </div>
        
        <div class="legend" id="legend" style="display: none;">
          <div class="legend-title">Escala</div>
          <div class="legend-gradient" id="legend-gradient">
            <div class="filter-indicator" id="filter-indicator"></div>
          </div>
          <div class="legend-labels"></div>
          <div style="text-align: center; margin-top: 8px; font-size: 11px; color: #666;">
            Haz clic en la escala para filtrar
          </div>
        </div>
      </div>

      <div id="hist"></div>
    </div>

    <!-- Municipality Data Modal -->
    <div class="municipality-modal" id="municipalityModal">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h2 class="modal-title" id="modalTitle">Ciudad de Rafael Lara</h2>
            <button class="download-btn" id="downloadCsvBtn">
              <i class="fa-solid fa-download"></i> Descargar (.CSV)
            </button>
          </div>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        
        <div class="modal-body">
          <h4>Resumen de Promedios</h4>
          <div class="pollutant-summary" id="pollutantSummary">
            <!-- Dynamic pollutant data will be inserted here -->
          </div>
          
          <div class="chart-container">
            <canvas id="pollutantChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Glossary Modal -->
    <div class="municipality-modal" id="glossaryModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Glosario de Términos</h2>
          <button class="modal-close" id="glossaryClose">&times;</button>
        </div>
        
        <div class="modal-body">
          <div style="max-height: 400px; overflow-y: auto;">
            <h4>Parámetros Meteorológicos</h4>
            <p><strong>Temperatura:</strong> Medida del grado de calor en la atmósfera, expresada en grados Celsius (°C).</p>
            <p><strong>Humedad:</strong> Cantidad de vapor de agua presente en el aire, expresada como porcentaje (%).</p>
            <p><strong>Precipitación:</strong> Cantidad de agua caída en forma de lluvia, nieve o granizo, medida en milímetros (mm).</p>
            <p><strong>Viento:</strong> Movimiento del aire en la atmósfera, medido en kilómetros por hora (km/h).</p>
            <p><strong>Presión:</strong> Fuerza ejercida por el aire sobre la superficie terrestre, medida en hectopascales (hPa).</p>
            
            <h4>Contaminantes del Aire</h4>
            <p><strong>CO (Monóxido de Carbono):</strong> Gas incoloro e inodoro producido por la combustión incompleta, medido en partes por millón (ppm).</p>
            <p><strong>NO₂ (Dióxido de Nitrógeno):</strong> Gas rojizo con olor acre, principalmente de vehículos, medido en partes por billón (ppb).</p>
            <p><strong>O₃ (Ozono):</strong> Gas formado por reacciones fotoquímicas en la atmósfera, medido en partes por billón (ppb).</p>
            <p><strong>PM2.5:</strong> Partículas finas menores a 2.5 micrómetros, medidas en microgramos por metro cúbico (μg/m³).</p>
          </div>
        </div>
      </div>
    </div>

    <script>
        // Global variables for storing JSON data
        let municipalitiesData = null;
        let stationsData = null;
        let mapInitialized = false;
        let mapIsReady = false; // <-- Add this line
        const initialCenter = [-98.2063, 19.0414];
        const initialZoom = 8.5;
        let colorFilter = null;
        let activeLayer = null;
        let animationInterval = null;
        let isPlaying = false;
        let currentTimeStep = 0;
// MODIFICATION: Added a new global variable for your custom boundary data
        let pueblaBoundaryData = null; 
        let pueblaSimpleBoundaryData = null; // <-- Add this line

        // Load JSON data
        // REPLACE this function
        async function loadJSONData() {
            try {
                // MODIFICATION: Added your 'puebla_state_boundary.json' to the files being fetched
                const [municipalitiesResponse, stationsResponse, pueblaResponse, pueblaStateResponse] = await Promise.all([
                    fetch('./cabeceras.json'),
                    fetch('./estaciones.json'),
                    fetch('./puebla_coordinates.json'),
                    fetch('./puebla_state_boundary.json') // <-- Add this line for your new file
                ]);
                
                municipalitiesData = await municipalitiesResponse.json();
                stationsData = await stationsResponse.json();
                pueblaBoundaryData = await pueblaResponse.json(); 
                pueblaSimpleBoundaryData = await pueblaStateResponse.json(); // <-- Store the new data
                
                console.log('JSON data loaded successfully');
                return true;
            } catch (error) {
                console.error('Error loading JSON data:', error);
                showNotification('Error cargando datos de municipios', 'error');
                return false;
            }
        }

        // Enhanced function to add realistic air quality data to municipalities
        function enrichMunicipalityData(municipality) {
            const coords = municipality.geometry.coordinates;
            const lng = coords[0];
            const lat = coords[1];
            
            let baseMultiplier = 1;
            
            const majorCities = ['Heroica Puebla de Zaragoza', 'TehuacÃ¡n', 'Atlixco', 'San MartÃ­n Texmelucan de Labastida'];
            if (majorCities.some(city => municipality.properties.nombre.includes(city.split(' ')[0]))) {
                baseMultiplier = 2.5;
            }
            
            const distanceFromCenter = Math.sqrt(Math.pow(lat - 19.04, 2) + Math.pow(lng + 98.2, 2));
            const urbanEffect = Math.max(0.5, 2 - distanceFromCenter * 2);
            
            const randomFactor = 0.8 + Math.random() * 0.4;
            const multiplier = baseMultiplier * urbanEffect * randomFactor;
            
            return {
                ...municipality.properties,
                population: estimatePopulation(municipality.properties.nombre),
                airQuality: {
                    co: Math.round((0.5 + Math.random() * 2) * multiplier * 10) / 10,
                    no2: Math.round((0.1 + Math.random() * 0.8) * multiplier * 10) / 10,
                    o3: Math.round((5 + Math.random() * 15) * multiplier * 10) / 10,
                    so2: Math.round(Math.random() * 0.3 * multiplier * 10) / 10,
                    pm10: Math.round((0.05 + Math.random() * 0.4) * multiplier * 100) / 100,
                    pm25: Math.round((0.02 + Math.random() * 0.2) * multiplier * 100) / 100
                }
            };
        }

        // Estimate population based on city name and type
        function estimatePopulation(cityName) {
            const majorCities = {
                'Heroica Puebla de Zaragoza': 1576259,
                'TehuacÃ¡n': 274906,
                'Atlixco': 127062,
                'San MartÃ­n Texmelucan de Labastida': 141112
            };
            
            for (const [name, pop] of Object.entries(majorCities)) {
                if (cityName.includes(name.split(' ')[0])) {
                    return pop;
                }
            }
            
            if (cityName.includes('Ciudad de')) {
                return 50000 + Math.random() * 100000;
            } else if (cityName.includes('San ') || cityName.includes('Santa ')) {
                return 20000 + Math.random() * 60000;
            } else {
                return 10000 + Math.random() * 40000;
            }
        }



// REPLACE this function to use your new file
function getSimplifiedPueblaStateBoundary() {
    return {
        "type": "Feature",
        "geometry": {
            "type": "Polygon",
            "coordinates": pueblaSimpleBoundaryData // Use the data loaded from your new file
        }
    };
}

// More accurate Puebla state boundary coordinates
// NEW, CORRECTED FUNCTION
function getAccuratePueblaStateBoundary() {
    // This adds the extra layer of nesting required for a valid GeoJSON MultiPolygon
    const validMultiPolygonCoords = pueblaBoundaryData.map(linearRing => [linearRing]);

    return {
        "type": "FeatureCollection",
        "features": [{
            "type": "Feature",
            "properties": { "name": "Puebla" },
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": validMultiPolygonCoords // Use the new, correctly formatted data
            }
        }]
    };
}
        // Add this new helper function
// UPDATED FUNCTION
function getPueblaBoundingBox() {
    // Using the simple boundary is much faster for this.
    const coords = getSimplifiedPueblaStateBoundary().geometry.coordinates[0];
    
    let minLng = coords[0][0], maxLng = coords[0][0];
    let minLat = coords[0][1], maxLat = coords[0][1];

    for (const coord of coords) {
        if (coord[0] < minLng) minLng = coord[0];
        if (coord[0] > maxLng) maxLng = coord[0];
        if (coord[1] < minLat) minLat = coord[1];
        if (coord[1] > maxLat) maxLat = coord[1];
    }
    
    return [[minLng - 0.1, minLat - 0.1], [maxLng + 0.1, maxLat + 0.1]];
}


// UPDATED FUNCTION
function addMapMask() {
    // This now uses the simple boundary, which will work correctly.
    const pueblaBoundary = getSimplifiedPueblaStateBoundary().geometry.coordinates[0];
    const worldWithPueblaHole = [
        [[-180, -90], [180, -90], [180, 90], [-180, 90], [-180, -90]],
        pueblaBoundary
    ];

    map.addSource('puebla-mask', {
        'type': 'geojson',
        'data': {
            'type': 'Feature',
            'geometry': {
                'type': 'Polygon',
                'coordinates': worldWithPueblaHole
            }
        }
    });

    map.addLayer({
        'id': 'puebla-mask-layer',
        'type': 'fill',
        'source': 'puebla-mask',
        'layout': {},
        'paint': {
            'fill-color': '#000',
            'fill-opacity': 0.7 
        }
    });
}

// UPDATED FUNCTION
function addAccuratePueblaStateBoundary() {
    // SOURCE 1: The detailed MultiPolygon for the borders (your original file)
    map.addSource('puebla-municipalities-boundary', {
        type: 'geojson',
        data: {
            type: 'Feature',
            geometry: {
                type: 'MultiPolygon',
                coordinates: pueblaBoundaryData.map(ring => [ring])
            }
        }
    });

    // SOURCE 2: The simple Polygon for the fast-rendering fill
    map.addSource('puebla-simple-boundary', {
        type: 'geojson',
        data: getSimplifiedPueblaStateBoundary()
    });
    
    // LAYER 1: The transparent fill based on the SIMPLE source
    map.addLayer({
        id: 'puebla-fill',
        type: 'fill',
        source: 'puebla-simple-boundary', // Use simple source
        paint: {
            'fill-color': 'rgba(90, 27, 48, 0.08)',
            'fill-opacity': 1 // Opacity can be 1 since color has alpha
        }
    });

    // LAYER 2: The border lines based on the DETAILED source
    map.addLayer({
        id: 'puebla-border',
        type: 'line',
        source: 'puebla-municipalities-boundary', // Use detailed source
        paint: {
            'line-color': '#FFFFFF',
            'line-width': 1.5, // Made it slightly thinner
            'line-opacity': 0.6
        }
    });
}

        // Updated function to add municipalities from JSON
        function addPueblaMunicipalities() {
            if (!municipalitiesData) {
                console.error('Municipality data not loaded');
                return;
            }

            const enrichedFeatures = municipalitiesData.features.map(feature => ({
                ...feature,
                properties: enrichMunicipalityData(feature)
            }));

            const enrichedData = {
                ...municipalitiesData,
                features: enrichedFeatures
            };

            map.addSource('puebla-municipalities', {
                type: 'geojson',
                data: enrichedData
            });

            map.addLayer({
                id: 'municipality-points',
                type: 'circle',
                source: 'puebla-municipalities',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'],
                        10000, 4,
                        50000, 8,
                        100000, 12,
                        500000, 16,
                        1500000, 20
                    ],
                    'circle-color': '#c19862', // Use fixed color instead of complex expression
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 2,
                    'circle-opacity': 0.8
                }
            });

            map.addLayer({
                id: 'municipality-labels',
                type: 'symbol',
                source: 'puebla-municipalities',
                layout: {
                    'text-field': ['get', 'nombre'],
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                    'text-size': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'],
                        10000, 10,
                        50000, 12,
                        100000, 14,
                        500000, 16,
                        1500000, 18
                    ],
                    'text-offset': [0, 2.5],
                    'text-anchor': 'top'
                },
                paint: {
                    'text-color': '#ffffff',
                    'text-halo-color': '#000000',
                    'text-halo-width': 2
                }
            });

            map.on('click', 'municipality-points', (e) => {
                console.log('Municipality clicked:', e.features[0]); // Debug log
                const properties = e.features[0].properties;
                console.log('Properties:', properties); // Debug log
                showMunicipalityModal(properties);
            });

            map.on('mouseenter', 'municipality-points', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'municipality-points', () => {
                map.getCanvas().style.cursor = '';
            });
        }

        // Add monitoring stations from JSON
        function addMonitoringStations() {
            if (!stationsData) {
                console.error('Stations data not loaded');
                return;
            }

            map.addSource('monitoring-stations', {
                type: 'geojson',
                data: stationsData
            });

            map.addLayer({
                id: 'station-points',
                type: 'circle',
                source: 'monitoring-stations',
                paint: {
                    'circle-radius': 8,
                    'circle-color': '#5a1b30',
                    'circle-stroke-color': '#c19862',
                    'circle-stroke-width': 3,
                    'circle-opacity': 0.9
                }
            });

            map.addLayer({
                id: 'station-labels',
                type: 'symbol',
                source: 'monitoring-stations',
                layout: {
                    'text-field': ['get', 'nombre'],
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                    'text-size': 12,
                    'text-offset': [0, -2.5],
                    'text-anchor': 'bottom'
                },
                paint: {
                    'text-color': '#5a1b30',
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 2
                }
            });

            map.on('click', 'station-points', (e) => {
                const properties = e.features[0].properties;
                showStationModal(properties);
            });
        }

        // Show station modal
        function showStationModal(properties) {
            showNotification(`Estación: ${properties.nombre} (${properties.clave})`, 'info');
        }

        // Enhanced municipality modal with real data structure
        function showMunicipalityModal(properties) {
            const modal = document.getElementById('municipalityModal');
            const title = document.getElementById('modalTitle');
            const summary = document.getElementById('pollutantSummary');
            
            const airQuality = typeof properties.airQuality === 'string' 
                ? JSON.parse(properties.airQuality) 
                : properties.airQuality;
            
            title.textContent = properties.nombre;
            summary.innerHTML = '';
            
            const pollutants = [
                { 
                    key: 'co', 
                    name: 'Monóxido de Carbono', 
                    unit: 'ppm',
                    color: '#8B4513', 
                    value: airQuality.co,
                    threshold: { good: 1, moderate: 2, bad: 3 }
                },
                { 
                    key: 'no2', 
                    name: 'Dióxido de Nitrógeno', 
                    unit: 'ppb',
                    color: '#6A5ACD', 
                    value: airQuality.no2,
                    threshold: { good: 0.3, moderate: 0.6, bad: 1.0 }
                },
                { 
                    key: 'o3', 
                    name: 'Ozono', 
                    unit: 'ppb',
                    color: '#32CD32', 
                    value: airQuality.o3,
                    threshold: { good: 8, moderate: 15, bad: 25 }
                },
                { 
                    key: 'so2', 
                    name: 'Dióxido de Azufre', 
                    unit: 'ppb',
                    color: '#4169E1', 
                    value: airQuality.so2,
                    threshold: { good: 0.1, moderate: 0.2, bad: 0.5 }
                },
                { 
                    key: 'pm10', 
                    name: 'PM 10', 
                    unit: 'μg/m³',
                    color: '#2F4F4F', 
                    value: airQuality.pm10,
                    threshold: { good: 0.15, moderate: 0.3, bad: 0.5 }
                },
                { 
                    key: 'pm25', 
                    name: 'PM 2.5', 
                    unit: 'μg/m³',
                    color: '#556B2F', 
                    value: airQuality.pm25,
                    threshold: { good: 0.1, moderate: 0.2, bad: 0.3 }
                }
            ];
            
            pollutants.forEach(pollutant => {
                const item = document.createElement('div');
                item.className = 'pollutant-item';
                
                let qualityLevel = 'good';
                if (pollutant.value > pollutant.threshold.bad) {
                    qualityLevel = 'bad';
                } else if (pollutant.value > pollutant.threshold.moderate) {
                    qualityLevel = 'moderate';
                }
                
                const qualityColors = {
                    good: '#00b894',
                    moderate: '#fdcb6e', 
                    bad: '#d63031'
                };
                
                item.innerHTML = `
                    <div class="pollutant-color" style="background-color: ${qualityColors[qualityLevel]}"></div>
                    <div class="pollutant-info">
                        <div class="pollutant-name">${pollutant.name} (${pollutant.unit})</div>
                        <div class="pollutant-value">${pollutant.value}</div>
                    </div>
                `;
                summary.appendChild(item);
            });
            
            createEnhancedPollutantChart(pollutants, properties.nombre);
            window.currentMunicipality = properties;
            modal.style.display = 'flex';
        }

        // Enhanced chart creation with realistic data patterns
        function createEnhancedPollutantChart(pollutants, cityName) {
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                showNotification('Error: Chart.js no está disponible', 'error');
                return;
            }

            const ctx = document.getElementById('pollutantChart').getContext('2d');
            
            // Destroy existing chart if it exists and has destroy method
            if (window.pollutantChart && typeof window.pollutantChart.destroy === 'function') {
                window.pollutantChart.destroy();
            }
            
            const timeLabels = [];
            const datasets = [];
            
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0') + ':00';
                timeLabels.push(hour);
            }
            
            pollutants.forEach(pollutant => {
                const data = generateRealistic24HourData(pollutant);
                
                datasets.push({
                    label: `${pollutant.name} (${pollutant.unit})`,
                    data: data,
                    borderColor: pollutant.color,
                    backgroundColor: pollutant.color + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: pollutant.color,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                });
            });
            
            window.pollutantChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Niveles de Contaminantes - ${cityName}`,
                            font: { size: 16, weight: 'bold' },
                            color: '#5a1b30'
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Concentración',
                                color: '#666'
                            },
                            grid: {
                                color: '#f0f0f0'
                            },
                            ticks: {
                                color: '#666'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora del día',
                                color: '#666'
                            },
                            grid: {
                                color: '#f0f0f0'
                            },
                            ticks: {
                                color: '#666'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            });
        }

        // Generate realistic 24-hour pollution data patterns
        function generateRealistic24HourData(pollutant) {
            const data = [];
            const baseValue = pollutant.value;
            
            for (let hour = 0; hour < 24; hour++) {
                let multiplier = 1;
                
                if (hour >= 6 && hour <= 9) {
                    multiplier = 1.4; // Morning rush
                } else if (hour >= 17 && hour <= 20) {
                    multiplier = 1.3; // Evening rush
                } else if (hour >= 22 || hour <= 5) {
                    multiplier = 0.7; // Night time
                }
                
                const variation = 0.8 + Math.random() * 0.4;
                const noiseFactor = Math.sin(hour * 0.5) * 0.1 + 1;
                
                let value = baseValue * multiplier * variation * noiseFactor;
                value = Math.max(value, baseValue * 0.3);
                
                if (pollutant.unit === 'ppm' || pollutant.unit === 'ppb') {
                    value = Math.round(value * 10) / 10;
                } else {
                    value = Math.round(value * 100) / 100;
                }
                
                data.push(value);
            }
            
            return data;
        }

        // Enhanced CSV download with proper data structure
        function downloadMunicipalityCSV(properties) {
            const airQuality = typeof properties.airQuality === 'string' 
                ? JSON.parse(properties.airQuality) 
                : properties.airQuality;
            
            const csvContent = [
                ['Municipio', 'Población', 'Contaminante', 'Concentración', 'Unidad'],
                [properties.nombre, properties.population, 'Monóxido de Carbono', airQuality.co, 'ppm'],
                [properties.nombre, properties.population, 'Dióxido de Nitrógeno', airQuality.no2, 'ppb'],
                [properties.nombre, properties.population, 'Ozono', airQuality.o3, 'ppb'],
                [properties.nombre, properties.population, 'Dióxido de Azufre', airQuality.so2, 'ppb'],
                [properties.nombre, properties.population, 'PM 10', airQuality.pm10, 'μg/m³'],
                [properties.nombre, properties.population, 'PM 2.5', airQuality.pm25, 'μg/m³']
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `calidad_aire_${properties.nombre.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Weather layers configuration
        const weatherLayers = {
            temperature: { 
                name: 'Temperatura', 
                unit: '°C', 
                gradient: 'linear-gradient(to right, #1e3c72, #2a5298, #74b9ff, #00b894, #fdcb6e, #e17055, #d63031)', 
                range: [-10, 40],
                heatmapColors: [
                    0, 'rgba(30, 60, 114, 0)',
                    0.1, '#1e3c72',
                    0.3, '#2a5298', 
                    0.5, '#74b9ff',
                    0.7, '#fdcb6e',
                    0.9, '#e17055',
                    1, '#d63031'
                ]
            },
            humidity: { 
                name: 'Humedad', 
                unit: '%', 
                gradient: 'linear-gradient(to right, #dfe6e9, #74b9ff, #0984e3, #2d3436)', 
                range: [0, 100],
                heatmapColors: [
                    0, 'rgba(223, 230, 233, 0)',
                    0.3, '#dfe6e9',
                    0.6, '#74b9ff',
                    0.8, '#0984e3',
                    1, '#2d3436'
                ]
            },
            precipitation: { 
                name: 'Precipitación', 
                unit: 'mm', 
                gradient: 'linear-gradient(to right, #f8f9fa, #74b9ff, #0984e3, #2d3436)', 
                range: [0, 100],
                heatmapColors: [
                    0, 'rgba(248, 249, 250, 0)',
                    0.2, '#f8f9fa',
                    0.4, '#74b9ff',
                    0.7, '#0984e3',
                    1, '#2d3436'
                ]
            },
            wind: { 
                name: 'Viento', 
                unit: 'km/h', 
                gradient: 'linear-gradient(to right, #f8f9fa, #fdcb6e, #e17055, #d63031, #74b9ff)', 
                range: [0, 150],
                heatmapColors: [
                    0, 'rgba(248, 249, 250, 0)',
                    0.2, '#f8f9fa',
                    0.4, '#fdcb6e',
                    0.6, '#e17055',
                    0.8, '#d63031',
                    1, '#74b9ff'
                ]
            },
            pressure: { 
                name: 'Presión', 
                unit: 'hPa', 
                gradient: 'linear-gradient(to right, #6c5ce7, #a29bfe, #fd79a8, #fdcb6e, #00b894)', 
                range: [980, 1040],
                heatmapColors: [
                    0, 'rgba(108, 92, 231, 0)',
                    0.25, '#6c5ce7',
                    0.5, '#a29bfe',
                    0.75, '#fdcb6e',
                    1, '#00b894'
                ]
            },
            radiation: { 
                name: 'Radiación', 
                unit: 'W/m²', 
                gradient: 'linear-gradient(to right, #2d3436, #636e72, #fdcb6e, #e17055, #fff)', 
                range: [0, 1000],
                heatmapColors: [
                    0, 'rgba(45, 52, 54, 0)',
                    0.2, '#2d3436',
                    0.4, '#636e72',
                    0.6, '#fdcb6e',
                    0.8, '#e17055',
                    1, '#ffffff'
                ]
            },
            co: { 
                name: 'Monóxido de Carbono', 
                unit: 'ppm', 
                gradient: 'linear-gradient(to right, #00b894, #fdcb6e, #e17055, #d63031, #2d3436)', 
                range: [0, 10],
                heatmapColors: [
                    0, 'rgba(0, 184, 148, 0)',
                    0.25, '#00b894',
                    0.5, '#fdcb6e',
                    0.75, '#e17055',
                    1, '#d63031'
                ]
            },
            no2: { 
                name: 'Dióxido de Nitrógeno', 
                unit: 'ppb', 
                gradient: 'linear-gradient(to right, #74b9ff, #0984e3, #fdcb6e, #e17055, #d63031)', 
                range: [0, 200],
                heatmapColors: [
                    0, 'rgba(116, 185, 255, 0)',
                    0.25, '#74b9ff',
                    0.5, '#0984e3',
                    0.75, '#e17055',
                    1, '#d63031'
                ]
            },
            o3: { 
                name: 'Ozono', 
                unit: 'ppb', 
                gradient: 'linear-gradient(to right, #a29bfe, #6c5ce7, #fd79a8, #e84393, #2d3436)', 
                range: [0, 150],
                heatmapColors: [
                    0, 'rgba(162, 155, 254, 0)',
                    0.25, '#a29bfe',
                    0.5, '#6c5ce7',
                    0.75, '#e84393',
                    1, '#2d3436'
                ]
            },
            pm25: { 
                name: 'PM2.5', 
                unit: 'μg/m³', 
                gradient: 'linear-gradient(to right, #00b894, #fdcb6e, #e17055, #d63031, #2d3436)', 
                range: [0, 200],
                heatmapColors: [
                    0, 'rgba(0, 184, 148, 0)',
                    0.2, '#00b894',
                    0.4, '#fdcb6e',
                    0.6, '#e17055',
                    0.8, '#d63031',
                    1, '#2d3436'
                ]
            }
        };

        // Generate smooth, interpolated weather data
        function generateSmoothWeatherData(type, timeStep = 0) {
            const data = [];
            const gridSize = 50;
            const range = weatherLayers[type].range;
            
            const pueblaBounds = {
                minLat: 17.6,
                maxLat: 20.4,
                minLng: -99.1,
                maxLng: -96.9
            };
            
            const weatherCenters = [
                { lat: 19.0414, lng: -98.2063, intensity: 0.8 },
                { lat: 18.4622, lng: -97.3953, intensity: 0.6 },
                { lat: 19.9311, lng: -97.9578, intensity: 0.7 },
                { lat: 18.9117, lng: -98.4307, intensity: 0.5 }
            ];
            
            const timeVariation = Math.sin(timeStep * 0.2) * 0.3;
            
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const lat = pueblaBounds.minLat + (i / gridSize) * (pueblaBounds.maxLat - pueblaBounds.minLat);
                    const lng = pueblaBounds.minLng + (j / gridSize) * (pueblaBounds.maxLng - pueblaBounds.minLng);
                    
                    if (isPointInPueblaAccurate(lat, lng)) {
                        let value = generateSmootherValue(type, lat, lng, timeStep, timeVariation, weatherCenters);
                        value = Math.max(range[0], Math.min(range[1], value));
                        
                        if (colorFilter && !isValueInColorFilter(value, range)) {
                            continue;
                        }
                        
                        data.push({
                            type: 'Feature',
                            geometry: { type: 'Point', coordinates: [lng, lat] },
                            properties: { 
                                value: value, 
                                intensity: (value - range[0]) / (range[1] - range[0]),
                                weight: Math.random() * 0.5 + 0.5
                            }
                        });
                    }
                }
            }
            return { type: 'FeatureCollection', features: data };
        }

        function isValueInColorFilter(value, range) {
            if (!colorFilter) return true;
            const normalizedValue = (value - range[0]) / (range[1] - range[0]);
            return normalizedValue >= colorFilter.min && normalizedValue <= colorFilter.max;
        }

        function generateSmootherValue(type, lat, lng, timeStep, timeVariation, weatherCenters) {
            const range = weatherLayers[type].range;
            let baseValue = range[0] + (range[1] - range[0]) * 0.5;
            
            let centerInfluence = 0;
            weatherCenters.forEach(center => {
                const distance = Math.sqrt(
                    Math.pow(lat - center.lat, 2) + Math.pow(lng - center.lng, 2)
                );
                const influence = center.intensity * Math.exp(-distance * 5);
                centerInfluence += influence;
            });
            
            const altitudeEffect = (lat - 18.5) * 0.1;
            const coastDistance = Math.abs(lng + 97.5);
            
            const noise1 = Math.sin(lat * 5 + lng * 4 + timeStep * 0.3) * 0.2;
            const noise2 = Math.sin(lat * 8 + lng * 6 + timeStep * 0.5) * 0.1;
            const noise3 = Math.sin(lat * 12 + lng * 10 + timeStep * 0.7) * 0.05;
            const totalNoise = noise1 + noise2 + noise3;
            
            switch (type) {
                case 'temperature':
                    baseValue = 22 + altitudeEffect * -2 + centerInfluence * 5 + timeVariation * 6 + totalNoise * 4;
                    break;
                case 'humidity':
                    baseValue = 60 + coastDistance * -8 + centerInfluence * 15 + timeVariation * 15 + totalNoise * 10;
                    break;
                case 'precipitation':
                    baseValue = Math.max(0, 3 + centerInfluence * 20 + timeVariation * 25 + totalNoise * 15);
                    break;
                case 'wind':
                    baseValue = 12 + centerInfluence * 10 + Math.abs(timeVariation) * 15 + totalNoise * 8;
                    break;
                case 'pressure':
                    baseValue = 1013 + altitudeEffect * -3 + centerInfluence * 8 + timeVariation * 10 + totalNoise * 5;
                    break;
                case 'radiation':
                    baseValue = 500 + centerInfluence * 200 + timeVariation * 250 + totalNoise * 100;
                    break;
                default:
                    baseValue = baseValue + centerInfluence * (range[1] - range[0]) * 0.4 + 
                               timeVariation * (range[1] - range[0]) * 0.25 + 
                               totalNoise * (range[1] - range[0]) * 0.15;
            }
            
            return baseValue;
        }

// Replace the old function with this one
// NEW, CORRECTED FUNCTION
// UPDATED FUNCTION
function isPointInPueblaAccurate(lat, lng) {
    // This is the biggest performance fix: check against one simple shape, not hundreds.
    const polygonBoundary = getSimplifiedPueblaStateBoundary().geometry.coordinates[0];
    let inside = false;
    for (let i = 0, j = polygonBoundary.length - 1; i < polygonBoundary.length; j = i++) {
        const xi = polygonBoundary[i][0], yi = polygonBoundary[i][1];
        const xj = polygonBoundary[j][0], yj = polygonBoundary[j][1];
        
        const intersect = ((yi > lat) !== (yj > lat))
            && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi);
        if (intersect) {
            inside = !inside;
        }
    }
    return inside;
}
        
        // REPLACE this entire function
function addEnhancedWeatherLayer(type) {
    if (!map || !mapIsReady) { return; } 

    if (activeLayer) {
        if (map.getLayer(activeLayer)) map.removeLayer(activeLayer);
        if (map.getLayer(activeLayer + '-points')) map.removeLayer(activeLayer + '-points');
        if (map.getSource(activeLayer)) map.removeSource(activeLayer);
    }
    
    const layerConfig = weatherLayers[type];
    const data = generateSmoothWeatherData(type, currentTimeStep);
    
    map.addSource(type, { type: 'geojson', data: data });
    
    // This layer draws the main heatmap
    map.addLayer({
        id: type,
        type: 'heatmap',
        source: type,
        paint: {
            'heatmap-weight': ['interpolate',['linear'],['get', 'weight'],0, 0.1,1, 1],
            'heatmap-intensity': ['interpolate',['exponential', 1.5],['zoom'],6, 0.8,10, 1.2,14, 1.8],
            'heatmap-color': ['interpolate',['linear'],['heatmap-density'],...layerConfig.heatmapColors],
            'heatmap-radius': ['interpolate',['exponential', 1.75],['zoom'],6, 25,10, 45,14, 80],
            'heatmap-opacity': ['interpolate',['linear'],['zoom'],6, 0.9,10, 0.8,14, 0.7]
        }
    }, 'puebla-border'); // <-- THE FIX: Draw heatmap UNDER the red borders

    // This layer draws the small circles when you zoom in
    map.addLayer({
        id: type + '-points',
        type: 'circle',
        source: type,
        minzoom: 10,
        paint: {
            'circle-radius': ['interpolate',['linear'],['zoom'],10, 2,14, 4],
            'circle-color': ['interpolate',['linear'],['get', 'intensity'],0, layerConfig.heatmapColors[1],1, layerConfig.heatmapColors[layerConfig.heatmapColors.length - 1]],
            'circle-opacity': ['interpolate',['linear'],['zoom'],10, 0.3,14, 0.6],
            'circle-stroke-width': 1,
            'circle-stroke-color': '#ffffff',
            'circle-stroke-opacity': 0.2
        }
    }, 'puebla-border'); // <-- ALSO FIX: Draw points UNDER the red borders
    
    activeLayer = type;
    updateLegend(layerConfig);
    updateDataPanel(type);
}
        
        function updateLegend(config) {
            const legend = document.getElementById('legend');
            legend.style.display = 'block';
            legend.querySelector('.legend-title').textContent = config.name;
            legend.querySelector('.legend-gradient').style.background = config.gradient;
            
            const labels = legend.querySelector('.legend-labels');
            labels.innerHTML = '';
            const steps = 4;
            for (let i = 0; i <= steps; i++) {
                const value = config.range[0] + (config.range[1] - config.range[0]) * (i / steps);
                const span = document.createElement('span');
                span.textContent = `${value.toFixed(0)}${i === steps ? " "+config.unit : ''}`;
                labels.appendChild(span);
            }
        }

        function updateDataPanel(type = 'temperature') {
            const config = weatherLayers[type] || weatherLayers.temperature;
            const centerLat = 19.0414;
            const centerLng = -98.2063;
            const timeVariation = Math.sin(currentTimeStep * 0.3) * 0.3;
            
            const tempValue = generateRealisticValue('temperature', centerLat, centerLng, currentTimeStep, timeVariation);
            const humidityValue = generateRealisticValue('humidity', centerLat, centerLng, currentTimeStep, timeVariation);
            const windValue = generateRealisticValue('wind', centerLat, centerLng, currentTimeStep, timeVariation);
            const pressureValue = generateRealisticValue('pressure', centerLat, centerLng, currentTimeStep, timeVariation);
            
            document.getElementById('tempValue').textContent = `${tempValue.toFixed(1)}°C`;
            document.getElementById('humidityValue').textContent = `${Math.max(0, Math.min(100, humidityValue)).toFixed(0)}%`;
            document.getElementById('windValue').textContent = `${Math.max(0, windValue).toFixed(1)} km/h`;
            document.getElementById('pressureValue').textContent = `${pressureValue.toFixed(0)} hPa`;
        }

        function generateRealisticValue(type, lat, lng, timeStep, timeVariation) {
            const range = weatherLayers[type].range;
            const baseValue = range[0] + (range[1] - range[0]) * 0.5;
            
            const altitudeEffect = (lat - 18.5) * 0.1;
            const coastDistance = Math.abs(lng + 97.5);
            
            const noise1 = Math.sin(lat * 10 + lng * 8 + timeStep * 0.5) * 0.3;
            const noise2 = Math.cos(lat * 7 + lng * 12 + timeStep * 0.3) * 0.2;
            
            let value = baseValue;
            
            switch (type) {
                case 'temperature':
                    value = 22 + altitudeEffect * -3 + coastDistance * 2 + timeVariation * 8 + noise1 * 5;
                    break;
                case 'humidity':
                    value = 60 + coastDistance * -10 + altitudeEffect * 5 + timeVariation * 20 + noise1 * 15;
                    break;
                case 'precipitation':
                    value = Math.max(0, 5 + altitudeEffect * 10 + timeVariation * 30 + noise1 * 20);
                    break;
                case 'wind':
                    value = 15 + coastDistance * 5 + Math.abs(timeVariation) * 20 + noise1 * 10;
                    break;
                case 'pressure':
                    value = 1013 + altitudeEffect * -5 + timeVariation * 15 + noise1 * 8;
                    break;
                case 'radiation':
                    value = 500 + timeVariation * 300 + noise1 * 100;
                    break;
                default:
                    value = baseValue + timeVariation * (range[1] - range[0]) * 0.3 + noise1 * (range[1] - range[0]) * 0.2;
            }
            
            return value;
        }

        function startAnimation() {
            if (isPlaying || !activeLayer) return;
            isPlaying = true;
            document.getElementById('playIcon').classList.replace('fa-play', 'fa-pause');
            
            const speed = 2100 - document.getElementById('speedSlider').value;
            
            animationInterval = setInterval(() => {
                currentTimeStep += 1;
                const data = generateSmoothWeatherData(activeLayer, currentTimeStep);
                if(map && map.getSource(activeLayer)) {
                    map.getSource(activeLayer).setData(data);
                }
                updateDataPanel(activeLayer);
                
                if (map.getLayer(activeLayer)) {
                    map.setPaintProperty(activeLayer, 'heatmap-opacity', 0.6);
                    setTimeout(() => {
                        if (map.getLayer(activeLayer)) {
                            map.setPaintProperty(activeLayer, 'heatmap-opacity', 0.8);
                        }
                    }, 100);
                }
            }, speed);
        }
        
        function stopAnimation() {
            isPlaying = false;
            document.getElementById('playIcon').classList.replace('fa-pause', 'fa-play');
            clearInterval(animationInterval);
            animationInterval = null;
        }

        function setupMapControls() {
            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                if (map) map.zoomIn({ duration: 300 });
            });

            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                if (map) map.zoomOut({ duration: 300 });
            });

            document.getElementById('reset-north-btn').addEventListener('click', () => {
                if (map) {
                    map.easeTo({
                        bearing: 0,
                        pitch: 45,
                        duration: 800,
                        easing: (t) => t * (2 - t)
                    });
                }
            });

            document.getElementById('reset-position-btn').addEventListener('click', () => {
                if (map) {
                    map.flyTo({
                        center: initialCenter,
                        zoom: initialZoom,
                        bearing: 0,
                        pitch: 45,
                        duration: 1500,
                        essential: true
                    });
                }
            });
        }

        function setupLegendClickFilter() {
            const legendGradient = document.getElementById('legend-gradient');
            const filterIndicator = document.getElementById('filter-indicator');
            
            let isSelecting = false;
            let startX = 0;
            
            legendGradient.addEventListener('mousedown', (e) => {
                isSelecting = true;
                startX = e.offsetX;
                filterIndicator.style.left = startX + 'px';
                filterIndicator.style.width = '2px';
                filterIndicator.style.display = 'block';
                e.preventDefault();
            });
            
            legendGradient.addEventListener('mousemove', (e) => {
                if (!isSelecting) return;
                
                const currentX = e.offsetX;
                const width = Math.abs(currentX - startX);
                const left = Math.min(startX, currentX);
                
                filterIndicator.style.left = left + 'px';
                filterIndicator.style.width = width + 'px';
            });
            
            legendGradient.addEventListener('mouseup', (e) => {
                if (!isSelecting) return;
                isSelecting = false;
                
                const endX = e.offsetX;
                const gradientWidth = legendGradient.offsetWidth;
                
                const minPercent = Math.min(startX, endX) / gradientWidth;
                const maxPercent = Math.max(startX, endX) / gradientWidth;
                
                if (Math.abs(endX - startX) > 5) {
                    colorFilter = { min: minPercent, max: maxPercent };
                    applyColorFilter();
                } else {
                    colorFilter = null;
                    filterIndicator.style.display = 'none';
                    applyColorFilter();
                }
            });
            
            legendGradient.addEventListener('mouseleave', () => {
                if (isSelecting) {
                    isSelecting = false;
                    if (!colorFilter) {
                        filterIndicator.style.display = 'none';
                    }
                }
            });
        }

        function applyColorFilter() {
            if (activeLayer) {
                const data = generateSmoothWeatherData(activeLayer, currentTimeStep);
                if (map && map.getSource(activeLayer)) {
                    map.getSource(activeLayer).setData(data);
                }
            }
        }

        // Updated map initialization to load JSON data first
        async function initializeMap() {
            if (mapInitialized) return;
            
            showLoadingIndicator();
            
            const dataLoaded = await loadJSONData();
            if (!dataLoaded) {
                hideLoadingIndicator();
                return;
            }
            
            mapboxgl.accessToken = 'pk.eyJ1IjoidGlsaW4yIiwiYSI6ImNtOG9wMzU4ZjAybnAyanE0dDdmY2x4cncifQ.YxHF3nxLS7LQX6ZlofvnGQ';
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: initialCenter,
                zoom: initialZoom,
                pitch: 45,
                bearing: 0,
                // Use the new function to set the map's navigation boundaries
                maxBounds: getPueblaBoundingBox()
            });
            
            map.on('load', () => {
                map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1' });
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.2 });
                map.addLayer({ 'id': 'sky', 'type': 'sky', 'paint': { 'sky-type': 'atmosphere', 'sky-atmosphere-sun-intensity': 15 } });
                
                // Call the new mask function first
                addMapMask(); 
                // Then call the rest
                addAccuratePueblaStateBoundary();
                addPueblaMunicipalities();
                addMonitoringStations();
                
                hideLoadingIndicator();
                mapIsReady = true; // <-- Add this line
            });
            
            map.on('error', () => {
                hideLoadingIndicator();
                console.error('Error loading map');
            });
            
            mapInitialized = true;
        }

        function toggleMenu() {
            const navLinks = document.getElementById('nav-links');
            navLinks.classList.toggle('active');
        }

        function activateMap(type) {
            document.body.classList.add('map-active');
            initializeMap();
            
            if (type === 'meteorologia') {
                setTimeout(() => {
                    const tempBtn = document.querySelector('[data-layer="temperature"]');
                    if (tempBtn) tempBtn.click();
                }, 500);
            } else if (type === 'calidad') {
                setTimeout(() => {
                    const pm25Btn = document.querySelector('[data-layer="pm25"]');
                    if (pm25Btn) pm25Btn.click();
                }, 500);
            }
        }

        function showLoadingIndicator() {
            const loader = document.createElement('div');
            loader.id = 'map-loader';
            loader.innerHTML = `
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255,255,255,0.9);
                    padding: 20px;
                    border-radius: 10px;
                    text-align: center;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                ">
                    <div style="
                        width: 40px;
                        height: 40px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #5a1b30;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 10px;
                    "></div>
                    <p style="margin: 0; color: #5a1b30; font-weight: 500;">Cargando mapa...</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            loader.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(248,249,250,0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            document.getElementById('main-content').appendChild(loader);
        }

        function hideLoadingIndicator() {
            const loader = document.getElementById('map-loader');
            if (loader) {
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    loader.remove();
                }, 300);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'error' ? '#d63031' : type === 'success' ? '#00b894' : '#0984e3'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                z-index: 3000;
                max-width: 300px;
                font-family: 'Poppins', sans-serif;
                font-size: 14px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Event Listeners Setup
        document.addEventListener('DOMContentLoaded', () => {
            setupMapControls();
            setupLegendClickFilter();

            const controlsPanel = document.getElementById('weather-controls');

            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const layerType = this.getAttribute('data-layer');
                    currentTimeStep = 0;
                    colorFilter = null;
                    document.getElementById('filter-indicator').style.display = 'none';
                    addEnhancedWeatherLayer(layerType);
                });
            });
            
            document.getElementById('playBtn').addEventListener('click', () => {
                isPlaying ? stopAnimation() : startAnimation();
            });
            
            document.getElementById('speedSlider').addEventListener('input', () => {
                if (isPlaying) {
                    stopAnimation();
                    startAnimation();
                }
            });
            
            document.getElementById('toggle-controls-btn').addEventListener('click', () => {
                controlsPanel.classList.add('is-open');
            });
            
            document.getElementById('close-controls-btn').addEventListener('click', () => {
                controlsPanel.classList.remove('is-open');
            });

            // Modal event listeners
            document.getElementById('modalClose').addEventListener('click', () => {
                document.getElementById('municipalityModal').style.display = 'none';
            });

            document.getElementById('glossaryClose').addEventListener('click', () => {
                document.getElementById('glossaryModal').style.display = 'none';
            });

            document.getElementById('downloadCsvBtn').addEventListener('click', () => {
                if (window.currentMunicipality) {
                    downloadMunicipalityCSV(window.currentMunicipality);
                } else {
                    showNotification('No hay datos disponibles para descargar', 'error');
                }
            });

            // Footer button event listeners
            document.getElementById('btn_glosario').addEventListener('click', () => {
                document.getElementById('glossaryModal').style.display = 'flex';
            });

            document.getElementById('btn_datos').addEventListener('click', () => {
                if (activeLayer) {
                    downloadLayerData(activeLayer);
                } else {
                    showNotification('Selecciona una capa primero para descargar los datos.', 'info');
                }
            });

            document.getElementById('btn_recarga').addEventListener('click', () => {
                if (activeLayer) {
                    currentTimeStep = 0;
                    colorFilter = null;
                    document.getElementById('filter-indicator').style.display = 'none';
                    addEnhancedWeatherLayer(activeLayer);
                }
            });

            // Back button functionality
            document.getElementById('btn_back').addEventListener('click', () => {
                document.body.classList.remove('map-active');
                document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                stopAnimation();
                currentTimeStep = 0;
                colorFilter = null;
                document.getElementById('legend').style.display = 'none';
                document.getElementById('filter-indicator').style.display = 'none';
                controlsPanel.classList.remove('is-open');
            });

            // Sidebar button functionality
            document.getElementById('btn_atmos').addEventListener('click', function() {
                if (!mapInitialized) activateMap('meteorologia');
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                setTimeout(() => {
                    const tempBtn = document.querySelector('[data-layer="temperature"]');
                    if (tempBtn) tempBtn.click();
                }, 300);
            });

            document.getElementById('btn_aire').addEventListener('click', function() {
                if (!mapInitialized) activateMap('calidad');
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                setTimeout(() => {
                    const pm25Btn = document.querySelector('[data-layer="pm25"]');
                    if (pm25Btn) pm25Btn.click();
                }, 300);
            });

            document.getElementById('btn_hist').addEventListener('click', function() {
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                showNotification('Funcionalidad de Historial en desarrollo', 'info');
            });

            // Mobile menu buttons
            document.getElementById('btn_atmos_mobile')?.addEventListener('click', (e) => {
                e.preventDefault();
                activateMap('meteorologia');
                toggleMenu();
            });

            document.getElementById('btn_aire_mobile')?.addEventListener('click', (e) => {
                e.preventDefault();
                activateMap('calidad');
                toggleMenu();
            });

            document.getElementById('btn_hist_mobile')?.addEventListener('click', (e) => {
                e.preventDefault();
                toggleMenu();
                showNotification('Funcionalidad de Historial en desarrollo', 'info');
            });

            // Update parameter selection functionality
            document.getElementById('select_dat').addEventListener('change', function() {
                const parameter = this.value;
                const subParamSelect = document.getElementById('select_var');
                
                subParamSelect.innerHTML = '';
                
                if (parameter === 'meteorologia') {
                    const meteorologicalParams = [
                        { value: 'temperature', text: 'Temperatura' },
                        { value: 'humidity', text: 'Humedad' },
                        { value: 'precipitation', text: 'Precipitación' },
                        { value: 'wind', text: 'Viento' },
                        { value: 'pressure', text: 'Presión' },
                        { value: 'radiation', text: 'Radiación' }
                    ];
                    
                    meteorologicalParams.forEach(param => {
                        const option = document.createElement('option');
                        option.value = param.value;
                        option.textContent = param.text;
                        subParamSelect.appendChild(option);
                    });
                } else if (parameter === 'calidad') {
                    const airQualityParams = [
                        { value: 'co', text: 'Monóxido de Carbono (CO)' },
                        { value: 'no2', text: 'Dióxido de Nitrógeno (NO₂)' },
                        { value: 'o3', text: 'Ozono (O₃)' },
                        { value: 'pm25', text: 'Partículas PM2.5' }
                    ];
                    
                    airQualityParams.forEach(param => {
                        const option = document.createElement('option');
                        option.value = param.value;
                        option.textContent = param.text;
                        subParamSelect.appendChild(option);
                    });
                }
            });

            // Update sub-parameter selection
            document.getElementById('select_var').addEventListener('change', function() {
                const selectedParam = this.value;
                if (selectedParam && weatherLayers[selectedParam]) {
                    const layerBtn = document.querySelector(`[data-layer="${selectedParam}"]`);
                    if (layerBtn) {
                        layerBtn.click();
                    }
                }
            });

            // Initialize parameter dropdowns
            document.getElementById('select_dat').dispatchEvent(new Event('change'));

            // Close modals when clicking outside
            document.getElementById('municipalityModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.style.display = 'none';
                }
            });

            document.getElementById('glossaryModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.style.display = 'none';
                }
            });
        });

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!document.body.classList.contains('map-active')) return;
            
            switch(e.key) {
                case 'Escape':
                    const controlsPanel = document.getElementById('weather-controls');
                    if (controlsPanel.classList.contains('is-open')) {
                        controlsPanel.classList.remove('is-open');
                    } else if (document.getElementById('municipalityModal').style.display === 'flex') {
                        document.getElementById('municipalityModal').style.display = 'none';
                    } else if (document.getElementById('glossaryModal').style.display === 'flex') {
                        document.getElementById('glossaryModal').style.display = 'none';
                    } else {
                        document.getElementById('btn_back').click();
                    }
                    break;
                case ' ':
                    e.preventDefault();
                    document.getElementById('playBtn').click();
                    break;
                case 'r':
                    document.getElementById('reset-position-btn').click();
                    break;
                case 'n':
                    document.getElementById('reset-north-btn').click();
                    break;
                case '+':
                case '=':
                    document.getElementById('zoom-in-btn').click();
                    break;
                case '-':
                    document.getElementById('zoom-out-btn').click();
                    break;
                case 'c':
                    colorFilter = null;
                    document.getElementById('filter-indicator').style.display = 'none';
                    applyColorFilter();
                    break;
                case 'g':
                    document.getElementById('btn_glosario').click();
                    break;
                case 'd':
                    document.getElementById('btn_datos').click();
                    break;
            }
        });

        // Enhanced touch gestures for mobile
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            if (!document.body.classList.contains('map-active')) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchmove', (e) => {
            if (!document.body.classList.contains('map-active')) return;
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if (!document.body.classList.contains('map-active')) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            const controlsPanel = document.getElementById('weather-controls');
            
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 100) {
                if (deltaX > 0 && controlsPanel.classList.contains('is-open')) {
                    controlsPanel.classList.remove('is-open');
                } else if (deltaX < 0 && !controlsPanel.classList.contains('is-open')) {
                    controlsPanel.classList.add('is-open');
                }
            }
        });

        // Performance optimization: Debounce resize events
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (map && mapInitialized) {
                    map.resize();
                }
            }, 250);
        });

        // Download layer data functionality
        function downloadLayerData(layerType) {
            const config = weatherLayers[layerType];
            const data = generateSmoothWeatherData(layerType, currentTimeStep);
            
            const csvRows = [
                ['Latitud', 'Longitud', config.name + ' (' + config.unit + ')']
            ];
            
            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const value = feature.properties.value;
                csvRows.push([coords[1].toFixed(4), coords[0].toFixed(4), value.toFixed(2)]);
            });
            
            const csvContent = csvRows.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${layerType}_puebla.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Error handling for missing resources
        window.addEventListener('error', (e) => {
            console.error('Error loading resource:', e.filename, e.message);
            if (e.filename && (e.filename.includes('images/') || e.filename.includes('.svg'))) {
                showNotification('Algunas imágenes no se pudieron cargar', 'error');
            }
        });

        // Add notification for filter usage
        let filterNotificationShown = false;
        document.getElementById('legend-gradient').addEventListener('mouseenter', () => {
            if (!filterNotificationShown) {
                showNotification('Haz clic y arrastra para filtrar por rangos de color. Presiona C para limpiar filtros.', 'info');
                filterNotificationShown = true;
            }
        });
    </script>
  </body>
  <canvas id="filter-canvas" style="display: none"></canvas>
</html>